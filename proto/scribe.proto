syntax = "proto3";
package scribe;

// Job status enumeration
enum JobStatus {
  JOB_STATUS_UNSPECIFIED = 0;
  QUEUED = 1;
  RUNNING = 2;
  COMPLETED = 3;
  FAILED = 4;
  CANCELED = 5;
}

// Common empty message
message Empty {}

// Health check messages
message HealthCheckRequest {}

message HealthCheckResponse {
  bool ok = 1;
  string message = 2;
}

// Audio source with flexible input options
message AudioSource {
  oneof source {
    string file_path = 1;
    bytes inline_wav = 2;
  }
}

// Transcription configuration options
message TranscriptionOptions {
  string model = 1;
  bool enable_gpu = 2;
  string language = 3;
  bool translate_to_english = 4;
  string initial_prompt = 5;
  float vad_threshold = 6;
  string compute_type = 7;
}

// Transcription segment
message Segment {
  int32 index = 1;
  float start = 2;
  float end = 3;
  string text = 4;
}

// Transcription request/response messages
message StartTranscriptionRequest {
  string job_id = 1;
  AudioSource audio = 2;
  TranscriptionOptions options = 3;
}

message StartTranscriptionResponse {
  string job_id = 1;
  JobStatus status = 2;
  string error = 3;
}

// Streaming transcription messages
message StreamTranscriptionRequest {
  string job_id = 1;
}

message TranscriptionEvent {
  string job_id = 1;
  JobStatus status = 2;
  float progress = 3;
  Segment segment = 4;
  string error = 5;
}

// Job management messages
message GetJobRequest {
  string job_id = 1;
}

message GetJobResponse {
  string job_id = 1;
  JobStatus status = 2;
  string error = 3;
  float progress = 4;
}

message ListJobsRequest {}

message JobSummary {
  string job_id = 1;
  JobStatus status = 2;
  string error = 3;
  string created_at = 4;
  string updated_at = 5;
}

message ListJobsResponse {
  repeated JobSummary jobs = 1;
}

message CancelJobRequest {
  string job_id = 1;
}

message CancelJobResponse {
  bool canceled = 1;
}

message DeleteJobRequest {
  string job_id = 1;
}

message DeleteJobResponse {
  bool deleted = 1;
}

// Transcript retrieval messages
message GetTranscriptRequest {
  string job_id = 1;
}

message GetTranscriptResponse {
  string job_id = 1;
  JobStatus status = 2;
  repeated Segment segments = 3;
  string audio_path = 4;
  string model = 5;
  string language = 6;
  string created_at = 7;
}

// Settings management messages
message Settings {
  string models_dir = 1;
  bool prefer_gpu = 2;
  string default_model = 3;
  string compute_type = 4;
}

message GetSettingsRequest {}

message GetSettingsResponse {
  Settings settings = 1;
}

message UpdateSettingsRequest {
  Settings settings = 1;
}

message UpdateSettingsResponse {
  Settings settings = 1;
}

// Model management messages
message ModelInfo {
  string name = 1;
  int64 size = 2;  // Size in bytes
  bool downloaded = 3;
}

message ListModelsRequest {}

message ListModelsResponse {
  repeated ModelInfo models = 1;
}

message DownloadModelRequest {
  string name = 1;
}

enum DownloadStatus {
  DOWNLOAD_STATUS_UNSPECIFIED = 0;
  DOWNLOAD_STARTING = 1;
  DOWNLOAD_DOWNLOADING = 2;
  DOWNLOAD_COMPLETE = 3;
  DOWNLOAD_FAILED = 4;
  DOWNLOAD_CANCELED = 5;
}

message DownloadModelProgress {
  string name = 1;
  DownloadStatus status = 2;
  int64 downloaded_bytes = 3;
  int64 total_bytes = 4;
  string error = 5;
}

message CancelDownloadRequest {
  string name = 1;
}

message CancelDownloadResponse {
  bool canceled = 1;
}

message DeleteModelRequest {
  string name = 1;
}

message DeleteModelResponse {
  string name = 1;
  bool deleted = 2;
}

// Main service definition
service Scribe {
  // Health and system
  rpc HealthCheck(HealthCheckRequest) returns (HealthCheckResponse);
  
  // Transcription operations
  rpc StartTranscription(StartTranscriptionRequest) returns (StartTranscriptionResponse);
  rpc StreamTranscription(StreamTranscriptionRequest) returns (stream TranscriptionEvent);
  
  // Job management
  rpc GetJob(GetJobRequest) returns (GetJobResponse);
  rpc ListJobs(ListJobsRequest) returns (ListJobsResponse);
  rpc CancelJob(CancelJobRequest) returns (CancelJobResponse);
  rpc DeleteJob(DeleteJobRequest) returns (DeleteJobResponse);
  rpc GetTranscript(GetTranscriptRequest) returns (GetTranscriptResponse);

  // Settings management
  rpc GetSettings(GetSettingsRequest) returns (GetSettingsResponse);
  rpc UpdateSettings(UpdateSettingsRequest) returns (UpdateSettingsResponse);
  
  // Model management
  rpc ListModels(ListModelsRequest) returns (ListModelsResponse);
  rpc DownloadModel(DownloadModelRequest) returns (stream DownloadModelProgress);
  rpc CancelDownload(CancelDownloadRequest) returns (CancelDownloadResponse);
  rpc DeleteModel(DeleteModelRequest) returns (DeleteModelResponse);
}